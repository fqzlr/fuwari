name: JSON Content Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-json:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get changed files
        id: changed
        uses: tj-actions/changed-files@v44

      - name: Validate possible JSON files
        run: |
          failed=0
          for file in ${{ steps.changed.outputs.all_changed_files }}; do
            echo "Checking $file"

            # 跳过删除的文件
            if [ ! -f "$file" ]; then
              continue
            fi

            # 判断文件是否可能是 JSON（以 { 或 [ 开头）
            first_char=$(head -c 1 "$file" | tr -d '[:space:]')

            if [[ "$first_char" == "{" || "$first_char" == "[" ]]; then
              echo "Possible JSON detected in $file"

              if ! jq empty "$file" > /dev/null 2>&1; then
                echo "❌ Invalid JSON in $file"
                failed=1
              else
                echo "✅ Valid JSON in $file"
              fi
            fi
          done

          if [ "$failed" -ne 0 ]; then
            echo "JSON validation failed."
            exit 1
          fi