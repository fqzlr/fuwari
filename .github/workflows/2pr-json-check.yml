name: PR JSON Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  check-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: JSON validation
        uses: actions/github-script@v7
        with:
          script: |
            const isManual = context.eventName === "workflow_dispatch";

            async function checkPR(pr) {
              const prNumber = pr.number;
              console.log(`Checking PR #${prNumber}`);

              const files = await github.paginate(
                github.rest.pulls.listFiles,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                }
              );

              let hasJsonFile = false;
              let allValid = true;

              for (const file of files) {
                if (file.status === "removed") continue;

                if (file.filename.endsWith(".json")) {
                  hasJsonFile = true;

                  try {
                    const content = await github.rest.repos.getContent({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      path: file.filename,
                      ref: pr.head.sha
                    });

                    const buff = Buffer.from(content.data.content, 'base64');
                    const text = buff.toString('utf8');

                    JSON.parse(text);

                    console.log(`${file.filename} ✅ valid JSON`);
                  } catch (e) {
                    console.log(`${file.filename} ❌ invalid JSON`);
                    allValid = false;
                  }
                }
              }

              if (!hasJsonFile) {
                console.log("No JSON files changed.");
                return;
              }

              const validLabel = "有效 JSON";
              const invalidLabel = "无效 JSON";

              if (allValid) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: [validLabel]
                });
              } else {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: [invalidLabel]
                });
              }
            }

            if (isManual) {
              const prs = await github.paginate(
                github.rest.pulls.list,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: "open"
                }
              );

              for (const pr of prs) {
                await checkPR(pr);
              }
            } else {
              await checkPR(context.payload.pull_request);
            }
