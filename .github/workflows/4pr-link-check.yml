name: 4PR Link Availability Check

on:
  workflow_run:
    workflows: ["PR Title Update From JSON"]
    types:
      - completed
  workflow_dispatch:

permissions:
  pull-requests: write
  contents: read

jobs:
  link-check:
    if: |
      github.event.workflow_run.conclusion == 'success' ||
      github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check links
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const validLabel = "有效 JSON";
            const ownershipLabel = "所有权验证未完成";

            async function getSiteUrl() {
              try {
                const configContent = fs.readFileSync("astro.config.mjs", "utf8");
                const match = configContent.match(/site:\s*["']([^"']+)["']/);
                if (match && match[1]) {
                  return match[1].replace(/\/$/, "");
                }
              } catch (err) {
                console.log("Failed to read astro.config.mjs");
              }
              return null;
            }

            async function checkUrl(targetUrl) {
              if (!targetUrl) return false;

              try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000);

                const res = await fetch(targetUrl, {
                  redirect: "follow",
                  signal: controller.signal
                });

                clearTimeout(timeout);

                return res.status === 200;
              } catch (e) {
                return false;
              }
            }

            async function processPR(prNumber) {

              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });

              const labels = pr.data.labels.map(l => l.name);

              if (!labels.includes(validLabel)) {
                console.log("Not valid JSON, skip.");
                return;
              }

              const files = await github.paginate(
                github.rest.pulls.listFiles,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                }
              );

              let jsonData = null;

              for (const file of files) {
                if (file.filename.endsWith(".json") && file.status !== "removed") {
                  const content = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: file.filename,
                    ref: pr.data.head.sha
                  });

                  const buff = Buffer.from(content.data.content, 'base64');
                  jsonData = JSON.parse(buff.toString("utf8"));
                  break;
                }
              }

              if (!jsonData) return;

              const siteUrl = await getSiteUrl();

              function resolveUrl(u) {
                if (!u) return null;

                if (u.startsWith("http://") || u.startsWith("https://")) {
                  return u;
                }

                if (u.startsWith("/") && siteUrl) {
                  return siteUrl + u;
                }

                return u;
              }

              const avatarUrl = resolveUrl(jsonData.avatar);
              const pageUrl = resolveUrl(jsonData.url);

              const avatarOk = await checkUrl(avatarUrl);
              const urlOk = await checkUrl(pageUrl);

              const newLabels = [
                avatarOk ? "avatar yes" : "avatar no",
                urlOk ? "url yes" : "url no"
              ];

              // 如果两个都成功
              if (avatarOk && urlOk) {
                newLabels.push(ownershipLabel);
              }

              // 删除旧状态标签
              const statusLabels = [
                "avatar yes",
                "avatar no",
                "url yes",
                "url no",
                ownershipLabel
              ];

              for (const l of statusLabels) {
                if (labels.includes(l)) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    name: l,
                  });
                }
              }

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                labels: newLabels,
              });

              console.log("Link check done.");
            }

            if (context.eventName === "workflow_dispatch") {

              const prs = await github.paginate(
                github.rest.pulls.list,
                {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: "open",
                }
              );

              for (const pr of prs) {
                await processPR(pr.number);
              }

            } else {

              const prNumber = context.payload.workflow_run.pull_requests[0]?.number;

              if (prNumber) {
                await processPR(prNumber);
              }

            }
