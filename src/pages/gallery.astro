---
import ViewsCounter from "@components/ViewsCounter.astro";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { Icon } from "astro-icon/components";
---

<MainGridLayout title="画廊">
	<div class="card-base p-6 md:p-8">
		<div class="flex items-center justify-between gap-3 flex-wrap mb-6">
			<div class="flex items-center gap-2">
				<div class="h-8 w-8 rounded-lg bg-[var(--primary)] flex items-center justify-center text-white dark:text-black/70">
					<Icon name="material-symbols:photo-library-rounded" class="text-[1.5rem]"></Icon>
				</div>
				<h1 class="text-2xl font-bold text-90">画廊</h1>
				<div id="status" class="text-sm font-bold text-50 transition-all"></div>
				<ViewsCounter pathname="/gallery/" />
			</div>
			<div class="flex items-center gap-2">
				<button id="btn-h" type="button" class="btn-regular h-9 px-3 rounded-lg text-sm font-medium">横屏</button>
				<button id="btn-v" type="button" class="btn-regular h-9 px-3 rounded-lg text-sm font-medium">竖屏</button>
				<button id="btn-sort" type="button" class="btn-regular h-9 px-3 rounded-lg text-sm font-medium">最新</button>
			</div>
		</div>

		<!-- 修改：更新图床说明，明确指定了目录 -->
		<div class="text-sm text-50 mb-5 leading-relaxed">
			图片资源自托管于：<a href="https://tu.682000.xyz" target="_blank" rel="noopener noreferrer" class="font-medium text-75 hover:text-[var(--primary)] transition-colors">tu.682000.xyz</a> 
            <br>
            当前目录：<b class="font-bold text-75">mn_background</b> (已开启随机图白名单)
            <br>
            特别鸣谢：<b class="font-bold text-75">锦瑟/瑞希</b> 大佬提供的图源
		</div>

		<div id="gallery" class="gallery-grid" data-ready="false"></div>
		<div id="footer-status" class="text-center text-sm text-50 h-10 mt-4"></div>
		<div id="sentinel" class="h-4"></div>
	</div>

	<style>
		.gallery-grid {
			width: 100%;
			opacity: 0;
			transform: translateY(4px);
			transition:
				opacity 0.2s ease,
				transform 0.2s ease;
		}
		.gallery-grid[data-ready="true"] {
			opacity: 1;
			transform: translateY(0);
		}
		.gallery-item {
			line-height: 24px;
		}
	</style>

	<script>
		import Masonry from "masonry-layout";
		import imagesLoaded from "imagesloaded";
		import { Fancybox } from "@fancyapps/ui";
		import "@fancyapps/ui/dist/fancybox/fancybox.css";

		// ================= 配置区域 =================
		const API_DOMAIN = "https://tu.682000.xyz"; // 你的图床域名
		const RANDOM_DIR = "mn_background";         // 【关键修改】指定唯一允许的目录
		const RANDOM_API_URL = `${API_DOMAIN}/random`; 
		// ===========================================

		let loadedCount = 0;
		let currentType = "h";
		let isReverse = false;
		let loading = false;
		let msnry = null;
		let io = null;
		let resizeHandler = null;

		const orientationMap = {
			h: "landscape", // 横图
			v: "portrait"   // 竖图
		};

		function getColumns() {
			const w = window.innerWidth;
			if (w >= 1024) return 4;
			if (w >= 768) return 3;
			return 2;
		}

		function getLayoutConfig(galleryEl) {
			const gutter = 16;
			const cols = getColumns();
			const width = galleryEl.clientWidth || 0;
			const columnWidth = Math.max(
				100, // 稍微减小最小宽度以适应更多图片
				Math.floor((width - gutter * (cols - 1)) / cols),
			);
			return { gutter, cols, columnWidth };
		}

		function setStatus(text) {
			const statusEl = document.getElementById("status");
			if (!statusEl) return;
			statusEl.textContent = text || "";
		}

		function updateStatus() {
			setStatus(`已加载 ${loadedCount} 张`);
		}

		function setActiveButton() {
			const btnH = document.getElementById("btn-h");
			const btnV = document.getElementById("btn-v");
			if (!btnH || !btnV) return;
			const activeClasses = ["ring-2", "ring-[var(--primary)]"];
			for (const c of activeClasses) {
				btnH.classList.toggle(c, currentType === "h");
				btnV.classList.toggle(c, currentType === "v");
			}
		}

		function updateSortButton() {
			const btnSort = document.getElementById("btn-sort");
			if (!btnSort) return;
			btnSort.textContent = isReverse ? "最早" : "最新";
			const activeClasses = ["ring-2", "ring-[var(--primary)]"];
			for (const c of activeClasses) {
				btnSort.classList.toggle(c, isReverse);
			}
		}

		// 【核心修改】构建请求时强制加入 dir 参数
		async function fetchRandomImageUrl() {
			try {
				const params = new URLSearchParams({
					content: "image",
					type: "url",
					form: "json",
					dir: RANDOM_DIR,              // 【关键】强制指定目录
					orientation: orientationMap[currentType]
				});

				const fullUrl = `${RANDOM_API_URL}?${params.toString()}`;
				// console.log("请求随机图API:", fullUrl);

				const res = await fetch(fullUrl, {
					cache: "no-cache",
					method: "GET"
				});

				if (!res.ok) throw new Error(`API返回错误: ${res.status}`);
				const data = await res.json();

				if (!data.url) throw new Error("API返回无图片URL");
				
				// 处理相对路径拼接
				const finalUrl = data.url.startsWith("http") ? data.url : `${API_DOMAIN}${data.url}`;
				return finalUrl;
			} catch (e) {
				console.error("获取单张图片失败:", e);
				return null;
			}
		}

		async function fetchRandomImages(batch = 1) {
			const urls = [];
			for (let i = 0; i < batch; i++) {
				const url = await fetchRandomImageUrl();
				if (url) urls.push(url);
			}
			return urls;
		}

		function resetLoadedCount() {
			loadedCount = 0;
		}

		function buildCard(url, width) {
			const a = document.createElement("a");
			a.href = url;
			a.dataset.fancybox = "";
			a.className = "gallery-item block opacity-0 transition-opacity duration-300";
			a.style.width = `${width}px`;

			const wrapper = document.createElement("div");
			wrapper.className = "card-base overflow-hidden rounded-xl active:scale-[0.99] transition";

			const img = document.createElement("img");
			img.src = url;
			img.loading = "lazy";
			img.decoding = "async";
			img.alt = `随机${currentType === "h" ? "横屏" : "竖屏"}图片`;
			img.className = "w-full h-auto block";

			wrapper.appendChild(img);
			a.appendChild(wrapper);
			a.appendChild(document.createElement("br"));
			return a;
		}

		function clearGallery() {
			const galleryEl = document.getElementById("gallery");
			if (!galleryEl) return;
			galleryEl.innerHTML = "";
			galleryEl.dataset.ready = "false";
			resetLoadedCount();
			if (msnry) {
				msnry.destroy();
				msnry = null;
			}
		}

		async function loadMore(batch = 20) {
			const galleryEl = document.getElementById("gallery");
			const footerStatus = document.getElementById("footer-status");
			if (!galleryEl || loading) return;
			
			loading = true;
			if (footerStatus) footerStatus.textContent = "加载中...";

			try {
				const { gutter, columnWidth } = getLayoutConfig(galleryEl);
				if (!msnry) {
					msnry = new Masonry(galleryEl, {
						itemSelector: ".gallery-item",
						gutter,
						columnWidth,
						transitionDuration: "0.2s",
					});
				}

				const imgUrls = await fetchRandomImages(batch);
				if (imgUrls.length === 0) {
					if (footerStatus) footerStatus.textContent = "暂无匹配的图片 (请检查目录设置)";
					return;
				}

				const frag = document.createDocumentFragment();
				const items = [];
				for (const url of imgUrls) {
					loadedCount++;
					const el = buildCard(url, columnWidth);
					items.push(el);
					frag.appendChild(el);
				}

				galleryEl.appendChild(frag);
				await new Promise((resolve) => {
					imagesLoaded(items, () => {
						if (!msnry) return resolve();
						msnry.appended(items);
						msnry.layout();
						for (const item of items) {
							item.classList.remove("opacity-0");
						}
						if (galleryEl.dataset.ready !== "true") galleryEl.dataset.ready = "true";
						resolve();
					});
				});
				
				updateStatus();
				if (footerStatus) footerStatus.textContent = "";

			} finally {
				loading = false;
			}
		}

		function setType(type) {
			if (type !== "h" && type !== "v") return;
			if (currentType === type) return;
			currentType = type;
			setActiveButton();
			updateStatus();
			clearGallery();
			loadMore(24);
		}

		function setupInfiniteLoad() {
			const sentinelEl = document.getElementById("sentinel");
			if (!sentinelEl) return;
			if (io) io.disconnect();
			io = new IntersectionObserver(
				(entries) => {
					if (entries.some((e) => e.isIntersecting && !loading)) {
						loadMore(20);
					}
				},
				{ rootMargin: "600px 0px" },
			);
			io.observe(sentinelEl);
		}

		function setupResize() {
			if (resizeHandler) window.removeEventListener("resize", resizeHandler);
			resizeHandler = () => {
				const galleryEl = document.getElementById("gallery");
				if (!galleryEl || !msnry) return;
				const { gutter, columnWidth } = getLayoutConfig(galleryEl);
				for (const el of galleryEl.querySelectorAll(".gallery-item")) {
					el.style.width = `${columnWidth}px`;
				}
				msnry.options.gutter = gutter;
				msnry.options.columnWidth = columnWidth;
				msnry.layout();
			};
			window.addEventListener("resize", resizeHandler, { passive: true });
		}

		function toggleSort() {
			isReverse = !isReverse;
			updateSortButton();
			clearGallery();
			loadMore(24);
		}

		async function init() {
			const galleryEl = document.getElementById("gallery");
			if (!galleryEl) return;
			if (galleryEl.dataset.inited === "true") return;
			galleryEl.dataset.inited = "true";

			setActiveButton();
			updateStatus();
			updateSortButton();
			clearGallery();
			await loadMore(24);
			
			const sentinelEl = document.getElementById("sentinel");
			if (sentinelEl && !loading) {
				const rect = sentinelEl.getBoundingClientRect();
				if (rect.top < window.innerHeight + 600) {
					loadMore(20);
				}
			}

			const btnH = document.getElementById("btn-h");
			const btnV = document.getElementById("btn-v");
			const btnSort = document.getElementById("btn-sort");
			if (btnH) btnH.addEventListener("click", () => setType("h"));
			if (btnV) btnV.addEventListener("click", () => setType("v"));
			if (btnSort) btnSort.addEventListener("click", toggleSort);
			updateSortButton();

			setupInfiniteLoad();
			setupResize();

			Fancybox.bind("[data-fancybox]", {
				groupAll: false,
				Toolbar: {
					display: {
						left: ["infobar"],
						middle: ["zoomIn", "zoomOut", "toggle1to1", "rotateCCW", "rotateCW", "flipX", "flipY"],
						right: ["slideshow", "fullscreen", "download", "thumbs", "close"],
					},
				},
				Thumbs: { type: "classic" },
				Carousel: { Navigation: false },
			});
		}

		function initIfPresent() {
			const galleryEl = document.getElementById("gallery");
			if (!galleryEl) return;
			init();
		}

		document.addEventListener("astro:before-swap", () => {
			Fancybox.destroy();
		});

		if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", initIfPresent);
		else initIfPresent();

		document.addEventListener("astro:after-swap", initIfPresent);
		document.addEventListener("content:replace", initIfPresent);
		document.addEventListener("swup:contentReplaced", initIfPresent);
	</script>
</MainGridLayout>